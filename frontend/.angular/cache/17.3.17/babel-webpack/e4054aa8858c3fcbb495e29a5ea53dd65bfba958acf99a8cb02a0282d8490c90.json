{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from \"@angular/core\";\nimport { forkJoin, of } from \"rxjs\";\nimport { catchError } from \"rxjs/operators\";\nlet DashboardComponent = class DashboardComponent {\n  constructor(api, snackBar, cdr) {\n    this.api = api;\n    this.snackBar = snackBar;\n    this.cdr = cdr;\n    this.investors = [];\n    this.loans = [];\n    this.Math = Math;\n    this.loading = false;\n    this.charts = {\n      churnBuckets: {\n        labels: [],\n        data: []\n      },\n      defaultBuckets: {\n        labels: [],\n        data: []\n      },\n      sectorExposure: {\n        labels: [],\n        data: []\n      },\n      aumBuckets: {\n        labels: [],\n        data: []\n      },\n      yieldEngagementTrend: {\n        labels: [],\n        data: []\n      },\n      dscrSummary: {\n        labels: [],\n        data: []\n      }\n    };\n    this.timeline = {\n      dates: [],\n      churn: [],\n      default: []\n    };\n    this.chartOptions = {\n      responsive: true,\n      plugins: {\n        legend: {\n          display: false\n        }\n      },\n      scales: {\n        x: {\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.05)\"\n          }\n        },\n        y: {\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.05)\"\n          },\n          beginAtZero: true\n        }\n      }\n    };\n    this.samples = {\n      investors: [],\n      loans: []\n    };\n    this.investorRows = [];\n    this.loanRows = [];\n    this.investorCount = 0;\n    this.loanCount = 0;\n    this.investorFilter = \"\";\n    this.loanFilter = \"\";\n    this.investorSortKey = \"\";\n    this.investorSortDir = \"asc\";\n    this.loanSortKey = \"\";\n    this.loanSortDir = \"asc\";\n    this.investorPage = 0;\n    this.loanPage = 0;\n    this.pageSize = 5;\n    this.pageSizeOptions = [5, 10, 25];\n    this.aiQuestion = \"\";\n    this.aiAnswer = \"\";\n    this.aiLoading = false;\n    this.aiHistory = [];\n    this.selectedHorizon = \"6m\";\n    this.aiOpen = true;\n    this.modelFamilies = [{\n      id: \"ensemble\",\n      label: \"Ensemble (RF+GB)\"\n    }, {\n      id: \"rf\",\n      label: \"Random Forest\"\n    }, {\n      id: \"logreg\",\n      label: \"Logistic Regression\"\n    }, {\n      id: \"adaboost\",\n      label: \"AdaBoost\"\n    }, {\n      id: \"knn\",\n      label: \"k-NN (local)\"\n    }];\n    this.selectedFamily = \"ensemble\";\n    this.compareFamily = \"adaboost\";\n    this.thresholdValue = 0.5;\n    this.costFP = 1000;\n    this.costFN = 5000;\n    this.selectedInvestor = null;\n    this.selectedLoan = null;\n    this.rocData = {\n      datasets: []\n    };\n    this.prData = {\n      datasets: []\n    };\n    this.radarData = {\n      labels: [],\n      datasets: []\n    };\n    this.bucketData = {\n      labels: [\"Low\", \"Medium\", \"High\"],\n      datasets: []\n    };\n    this.compareRoc = {\n      datasets: []\n    };\n    this.comparePr = {\n      datasets: []\n    };\n    this.lineOptions = {\n      responsive: true,\n      plugins: {\n        legend: {\n          display: true,\n          labels: {\n            color: \"#9bb0c9\"\n          }\n        }\n      },\n      elements: {\n        point: {\n          radius: 2\n        }\n      },\n      parsing: false,\n      scales: {\n        x: {\n          type: \"linear\",\n          min: 0,\n          max: 1,\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.08)\"\n          }\n        },\n        y: {\n          min: 0,\n          max: 1,\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.08)\"\n          }\n        }\n      }\n    };\n  }\n  ngOnInit() {\n    this.loadData();\n  }\n  loadData() {\n    this.loading = true;\n    this.api.batchRefresh().subscribe({\n      next: () => {\n        forkJoin({\n          investors: this.api.getInvestors(),\n          loans: this.api.getLoans(),\n          report: this.api.generateReport(),\n          analytics: this.api.getAnalyticsOverview(),\n          samples: this.api.getAnalyticsSamples(50),\n          metrics: this.api.getAllModelMetrics(),\n          drift: this.api.getDrift().pipe(catchError(() => of(null))),\n          audit: this.api.getDataAudit().pipe(catchError(() => of(null))),\n          timeline: this.api.getTimeline(45).pipe(catchError(() => of({\n            dates: [],\n            churn: [],\n            default: []\n          })))\n        }).subscribe({\n          next: ({\n            investors,\n            loans,\n            report,\n            analytics,\n            samples,\n            timeline,\n            metrics,\n            drift,\n            audit\n          }) => {\n            this.investors = investors.items;\n            this.loans = loans.items;\n            this.report = report;\n            this.samples = samples;\n            this.timeline = timeline;\n            this.analyticsRaw = analytics;\n            this.modelMetrics = metrics;\n            this.driftSummary = drift;\n            this.dataAudit = audit;\n            this.updateCurveData();\n            // prefer full investor/loan lists to avoid empty sample payloads\n            this.investorRows = investors.items || [];\n            this.loanRows = loans.items || [];\n            this.investorCount = investors.items?.length || 0;\n            this.loanCount = loans.items?.length || 0;\n            this.populateCharts(analytics);\n            this.loading = false;\n            this.cdr.detectChanges();\n          },\n          error: err => this.handleError(\"Failed to load dashboard data\", err)\n        });\n      },\n      error: err => this.handleError(\"Failed to refresh scores\", err)\n    });\n  }\n  refreshReport() {\n    this.loading = true;\n    this.api.generateReport().subscribe({\n      next: report => {\n        this.report = report;\n        this.loading = false;\n        this.snackBar.open(\"Report refreshed\", \"Close\", {\n          duration: 2000\n        });\n      },\n      error: err => this.handleError(\"Failed to refresh report\", err)\n    });\n  }\n  changeHorizon(h) {\n    this.selectedHorizon = h;\n    if (this.analyticsRaw) {\n      this.populateCharts(this.analyticsRaw);\n    }\n    this.updateCurveData();\n  }\n  changeFamily(fam) {\n    this.selectedFamily = fam;\n    this.updateCurveData();\n    this.updateRadar();\n    this.updateComparisonCurves();\n  }\n  explainDashboard() {\n    this.aiQuestion = \"Explain todayâ€™s dashboard risk picture in 3 bullets.\";\n    this.askAi();\n  }\n  investorBuckets() {\n    return this.report?.summary_kpis.investor_buckets || {\n      Low: 0,\n      Medium: 0,\n      High: 0\n    };\n  }\n  loanBuckets() {\n    return this.report?.summary_kpis.loan_buckets || {\n      Low: 0,\n      Medium: 0,\n      High: 0\n    };\n  }\n  topInvestors() {\n    return this.report?.summary_kpis.top_investors || [];\n  }\n  topLoans() {\n    return this.report?.summary_kpis.top_loans || [];\n  }\n  formatPercent(prob) {\n    if (prob === undefined || prob === null) {\n      return \"0.0%\";\n    }\n    return `${(prob * 100).toFixed(1)}%`;\n  }\n  populateCharts(analytics) {\n    if (!analytics) {\n      this.charts.churnBuckets = {\n        labels: [\"Low\", \"Medium\", \"High\"],\n        data: [0, 0, 0]\n      };\n      this.charts.defaultBuckets = {\n        labels: [\"Low\", \"Medium\", \"High\"],\n        data: [0, 0, 0]\n      };\n      this.charts.sectorExposure = {\n        labels: [],\n        data: []\n      };\n      this.charts.aumBuckets = {\n        labels: [],\n        data: []\n      };\n      this.charts.yieldEngagementTrend = {\n        labels: [],\n        data: []\n      };\n      this.charts.dscrSummary = {\n        labels: [\"p25\", \"p50\", \"p75\"],\n        data: [0, 0, 0]\n      };\n      return;\n    }\n    const h = this.selectedHorizon;\n    const churnSrc = analytics.churn_buckets_by_horizon?.[h] || analytics.churn_buckets || {};\n    const defaultSrc = analytics.default_buckets_by_horizon?.[h] || analytics.default_buckets || {};\n    this.charts.churnBuckets = {\n      labels: Object.keys(churnSrc || {}),\n      data: Object.values(churnSrc || {})\n    };\n    this.charts.defaultBuckets = {\n      labels: Object.keys(defaultSrc || {}),\n      data: Object.values(defaultSrc || {})\n    };\n    const sortedSector = Object.entries(analytics.sector_exposure || {}).sort((a, b) => b[1].exposure - a[1].exposure);\n    this.charts.sectorExposure = {\n      labels: sortedSector.map(s => s[0]),\n      data: sortedSector.map(s => s[1].exposure)\n    };\n    this.charts.aumBuckets = {\n      labels: Object.keys(analytics.aum_buckets || {}),\n      data: Object.values(analytics.aum_buckets || {})\n    };\n    // Create a simple line series for yield and engagement medians to show trend-like context\n    const yieldMed = analytics.distribution_yield?.p50 ?? 0;\n    const engMed = analytics.engagement?.p50 ?? 0;\n    this.charts.yieldEngagementTrend = {\n      labels: [\"Engagement median\", \"Yield median\"],\n      data: [engMed, yieldMed * 100]\n    };\n    const dscr = analytics.dscr || {};\n    this.charts.dscrSummary = {\n      labels: [\"p25\", \"p50\", \"p75\"],\n      data: [dscr.p25 ?? 0, dscr.p50 ?? 0, dscr.p75 ?? 0]\n    };\n  }\n  applyInvestorFilter(filterValue) {\n    this.investorFilter = filterValue.trim().toLowerCase();\n    this.investorPage = 0;\n  }\n  applyLoanFilter(filterValue) {\n    this.loanFilter = filterValue.trim().toLowerCase();\n    this.loanPage = 0;\n  }\n  filteredInvestors() {\n    const term = this.investorFilter || \"\";\n    if (!term) return this.investorRows;\n    return this.investorRows.filter(i => [i.name, i.risk_tolerance, i.risk_bucket].some(v => (v || \"\").toString().toLowerCase().includes(term)));\n  }\n  filteredLoans() {\n    const term = this.loanFilter || \"\";\n    if (!term) return this.loanRows;\n    return this.loanRows.filter(l => [l.id, l.sector, l.risk_bucket].some(v => (v || \"\").toString().toLowerCase().includes(term)));\n  }\n  sortArray(arr, key, dir) {\n    if (!key) return arr;\n    return [...arr].sort((a, b) => {\n      const va = a?.[key] ?? \"\";\n      const vb = b?.[key] ?? \"\";\n      if (va < vb) return dir === \"asc\" ? -1 : 1;\n      if (va > vb) return dir === \"asc\" ? 1 : -1;\n      return 0;\n    });\n  }\n  sortedInvestors() {\n    return this.sortArray(this.filteredInvestors(), this.investorSortKey, this.investorSortDir);\n  }\n  sortedLoans() {\n    return this.sortArray(this.filteredLoans(), this.loanSortKey, this.loanSortDir);\n  }\n  pagedInvestors() {\n    const start = this.investorPage * this.pageSize;\n    return this.sortedInvestors().slice(start, start + this.pageSize);\n  }\n  pagedLoans() {\n    const start = this.loanPage * this.pageSize;\n    return this.sortedLoans().slice(start, start + this.pageSize);\n  }\n  setInvestorPage(delta) {\n    const total = this.filteredInvestors().length;\n    const maxPage = Math.max(0, Math.ceil(total / this.pageSize) - 1);\n    this.investorPage = Math.min(maxPage, Math.max(0, this.investorPage + delta));\n  }\n  setLoanPage(delta) {\n    const total = this.filteredLoans().length;\n    const maxPage = Math.max(0, Math.ceil(total / this.pageSize) - 1);\n    this.loanPage = Math.min(maxPage, Math.max(0, this.loanPage + delta));\n  }\n  changePageSize(size) {\n    this.pageSize = size;\n    this.investorPage = 0;\n    this.loanPage = 0;\n  }\n  toggleInvestorSort(key) {\n    if (this.investorSortKey === key) {\n      this.investorSortDir = this.investorSortDir === \"asc\" ? \"desc\" : \"asc\";\n    } else {\n      this.investorSortKey = key;\n      this.investorSortDir = \"asc\";\n    }\n    this.investorPage = 0;\n  }\n  toggleLoanSort(key) {\n    if (this.loanSortKey === key) {\n      this.loanSortDir = this.loanSortDir === \"asc\" ? \"desc\" : \"asc\";\n    } else {\n      this.loanSortKey = key;\n      this.loanSortDir = \"asc\";\n    }\n    this.loanPage = 0;\n  }\n  askAi() {\n    if (!this.aiQuestion) return;\n    this.aiLoading = true;\n    this.aiHistory.push({\n      role: \"user\",\n      content: this.aiQuestion\n    });\n    const context = {\n      report: this.report,\n      charts: this.charts,\n      timeline: this.timeline,\n      topInvestors: this.topInvestors(),\n      topLoans: this.topLoans(),\n      samples: this.samples\n    };\n    this.api.askAi(this.aiQuestion, \"dashboard\", context, this.aiHistory).subscribe({\n      next: resp => {\n        this.aiAnswer = resp.answer;\n        this.aiHistory.push({\n          role: \"assistant\",\n          content: resp.answer\n        });\n        this.aiLoading = false;\n        this.aiQuestion = \"\";\n      },\n      error: err => this.handleError(\"AI explanation failed\", err)\n    });\n  }\n  handleError(message, err) {\n    console.error(message, err);\n    this.loading = false;\n    this.snackBar.open(message, \"Close\", {\n      duration: 3000\n    });\n  }\n  familyMetrics() {\n    const famBlock = this.modelMetrics?.model_families || {};\n    const h = this.selectedHorizon;\n    return {\n      churn: famBlock.churn?.[this.selectedFamily]?.[h],\n      default: famBlock.default?.[this.selectedFamily]?.[h]\n    };\n  }\n  thresholdsFor(problem) {\n    const famBlock = this.modelMetrics?.model_families?.[problem]?.[this.selectedFamily]?.[this.selectedHorizon];\n    const familyThresholds = famBlock?.thresholds || [];\n    if (familyThresholds.length) return familyThresholds;\n    return this.modelMetrics?.thresholds?.[problem]?.[this.selectedHorizon] || [];\n  }\n  cohortRisk() {\n    return this.analyticsRaw?.cohort_risk || {};\n  }\n  nearestThreshold(problem) {\n    const thresholds = this.thresholdsFor(problem);\n    if (!thresholds.length) return null;\n    let best = thresholds[0];\n    let bestDiff = Math.abs(best.threshold - this.thresholdValue);\n    for (const t of thresholds) {\n      const diff = Math.abs(t.threshold - this.thresholdValue);\n      if (diff < bestDiff) {\n        best = t;\n        bestDiff = diff;\n      }\n    }\n    return best;\n  }\n  thresholdStats() {\n    return {\n      churn: this.nearestThreshold(\"churn\"),\n      default: this.nearestThreshold(\"default\")\n    };\n  }\n  segmentScores() {\n    return this.analyticsRaw?.segment_scores || {};\n  }\n  predictorBenchmarks() {\n    const bench = this.modelMetrics?.single_feature_benchmarks || {};\n    const toRows = obj => Object.entries(obj || {}).map(([name, val]) => ({\n      name,\n      auc: val?.roc_auc || 0\n    })).sort((a, b) => b.auc - a.auc);\n    return {\n      churn: toRows(bench.churn),\n      default: toRows(bench.default)\n    };\n  }\n  hyperparams() {\n    return this.modelMetrics?.hyperparameters || {};\n  }\n  sensitivityRows() {\n    const sens = this.modelMetrics?.sensitivity || {};\n    const toRows = obj => Object.entries(obj || {}).map(([feat, vals]) => ({\n      feature: feat,\n      up: (vals?.up_flip_pct || 0) * 100,\n      down: (vals?.down_flip_pct || 0) * 100\n    })).sort((a, b) => b.up - a.up);\n    return {\n      churn: toRows(sens.churn),\n      default: toRows(sens.default)\n    };\n  }\n  thresholdCost(problem) {\n    const stats = this.thresholdStats()[problem];\n    if (!stats) return null;\n    const fp = stats.fp || 0;\n    const fn = stats.fn || 0;\n    return {\n      fp,\n      fn,\n      cost_fp: fp * this.costFP,\n      cost_fn: fn * this.costFN,\n      total: fp * this.costFP + fn * this.costFN\n    };\n  }\n  runPortfolioScenario() {\n    this.loading = true;\n    this.api.runPortfolioScenario({\n      horizon: this.selectedHorizon\n    }).subscribe({\n      next: resp => {\n        this.scenarioResult = resp;\n        this.loading = false;\n        this.snackBar.open(\"Scenario calculated\", \"Close\", {\n          duration: 2000\n        });\n      },\n      error: err => this.handleError(\"Failed to run portfolio scenario\", err)\n    });\n  }\n  imputationRows() {\n    const missing = this.modelMetrics?.missing_data || {};\n    const toRows = obj => Object.entries(obj || {}).map(([name, vals]) => ({\n      strategy: name,\n      auc: vals?.roc_auc || 0,\n      ap: vals?.avg_precision || 0\n    }));\n    return {\n      churn: toRows(missing.churn),\n      default: toRows(missing.default)\n    };\n  }\n  bootstrapStats() {\n    return this.modelMetrics?.bootstrap_ci || {};\n  }\n  cohortModels() {\n    return this.modelMetrics?.cohort_models || {};\n  }\n  selectInvestor(inv) {\n    this.selectedInvestor = inv;\n    this.selectedLoan = null;\n  }\n  selectLoan(loan) {\n    this.selectedLoan = loan;\n    this.selectedInvestor = null;\n  }\n  updateCurveData() {\n    const churnThr = this.thresholdsFor(\"churn\");\n    const defaultThr = this.thresholdsFor(\"default\");\n    this.rocData = {\n      datasets: [{\n        label: \"Churn ROC\",\n        data: churnThr.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#19c3b1\",\n        backgroundColor: \"rgba(25,195,177,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }, {\n        label: \"Default ROC\",\n        data: defaultThr.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#4f46e5\",\n        backgroundColor: \"rgba(79,70,229,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }]\n    };\n    this.prData = {\n      datasets: [{\n        label: \"Churn PR\",\n        data: churnThr.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#10b981\",\n        backgroundColor: \"rgba(16,185,129,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }, {\n        label: \"Default PR\",\n        data: defaultThr.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#f59e0b\",\n        backgroundColor: \"rgba(245,158,11,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }]\n    };\n    this.updateRadar();\n    this.updateComparisonCurves();\n  }\n  updateRadar() {\n    const fam = this.familyMetrics();\n    const churn = fam?.churn || {};\n    const defm = fam?.default || {};\n    const labels = [\"Accuracy\", \"Precision\", \"Recall\", \"ROC AUC\", \"Avg Precision\"];\n    const churnVals = [churn.accuracy || 0, churn.precision || 0, churn.recall || 0, churn.roc_auc || 0, churn.avg_precision || 0];\n    const defVals = [defm.accuracy || 0, defm.precision || 0, defm.recall || 0, defm.roc_auc || 0, defm.avg_precision || 0];\n    this.radarData = {\n      labels,\n      datasets: [{\n        label: \"Churn\",\n        data: churnVals,\n        borderColor: \"#19c3b1\",\n        backgroundColor: \"rgba(25,195,177,0.2)\"\n      }, {\n        label: \"Default\",\n        data: defVals,\n        borderColor: \"#4f46e5\",\n        backgroundColor: \"rgba(79,70,229,0.2)\"\n      }]\n    };\n    const churnBuckets = [churn.bucket_low || 0, churn.bucket_med || 0, churn.bucket_high || 0];\n    const defaultBuckets = [defm.bucket_low || 0, defm.bucket_med || 0, defm.bucket_high || 0];\n    this.bucketData = {\n      labels: [\"Low\", \"Medium\", \"High\"],\n      datasets: [{\n        label: \"Churn buckets\",\n        data: churnBuckets,\n        backgroundColor: \"rgba(25,195,177,0.4)\"\n      }, {\n        label: \"Default buckets\",\n        data: defaultBuckets,\n        backgroundColor: \"rgba(79,70,229,0.4)\"\n      }]\n    };\n  }\n  changeCompareFamily(f) {\n    this.compareFamily = f;\n    this.updateComparisonCurves();\n  }\n  thresholdsForFamily(problem, family) {\n    const famBlock = this.modelMetrics?.model_families?.[problem]?.[family]?.[this.selectedHorizon];\n    return famBlock?.thresholds || [];\n  }\n  updateComparisonCurves() {\n    const famA = this.selectedFamily;\n    const famB = this.compareFamily;\n    const churnA = this.thresholdsForFamily(\"churn\", famA);\n    const churnB = this.thresholdsForFamily(\"churn\", famB);\n    const defA = this.thresholdsForFamily(\"default\", famA);\n    const defB = this.thresholdsForFamily(\"default\", famB);\n    this.compareRoc = {\n      datasets: [{\n        label: `Churn ${famA}`,\n        data: churnA.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#19c3b1\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Churn ${famB}`,\n        data: churnB.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#f97316\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famA}`,\n        data: defA.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#4f46e5\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famB}`,\n        data: defB.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#22c55e\",\n        fill: false,\n        tension: 0.1\n      }]\n    };\n    this.comparePr = {\n      datasets: [{\n        label: `Churn ${famA}`,\n        data: churnA.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#10b981\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Churn ${famB}`,\n        data: churnB.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#f59e0b\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famA}`,\n        data: defA.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#6366f1\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famB}`,\n        data: defB.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#ef4444\",\n        fill: false,\n        tension: 0.1\n      }]\n    };\n  }\n};\nDashboardComponent = __decorate([Component({\n  selector: \"app-dashboard\",\n  templateUrl: \"./dashboard.component.html\",\n  styleUrls: [\"./dashboard.component.scss\"]\n})], DashboardComponent);\nexport { DashboardComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}