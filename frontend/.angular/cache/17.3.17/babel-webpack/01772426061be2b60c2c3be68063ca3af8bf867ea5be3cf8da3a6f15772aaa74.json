{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from \"@angular/core\";\nimport { forkJoin, of } from \"rxjs\";\nimport { catchError } from \"rxjs/operators\";\nlet DashboardComponent = class DashboardComponent {\n  constructor(api, snackBar, cdr) {\n    this.api = api;\n    this.snackBar = snackBar;\n    this.cdr = cdr;\n    this.investors = [];\n    this.loans = [];\n    this.Math = Math;\n    this.loading = false;\n    this.charts = {\n      churnBuckets: {\n        labels: [],\n        data: []\n      },\n      defaultBuckets: {\n        labels: [],\n        data: []\n      },\n      sectorExposure: {\n        labels: [],\n        data: []\n      },\n      aumBuckets: {\n        labels: [],\n        data: []\n      },\n      yieldEngagementTrend: {\n        labels: [],\n        data: []\n      },\n      dscrSummary: {\n        labels: [],\n        data: []\n      }\n    };\n    this.timeline = {\n      dates: [],\n      churn: [],\n      default: []\n    };\n    this.chartOptions = {\n      responsive: true,\n      plugins: {\n        legend: {\n          display: false\n        }\n      },\n      scales: {\n        x: {\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.05)\"\n          }\n        },\n        y: {\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.05)\"\n          },\n          beginAtZero: true\n        }\n      }\n    };\n    this.samples = {\n      investors: [],\n      loans: []\n    };\n    this.investorRows = [];\n    this.loanRows = [];\n    this.investorFilter = \"\";\n    this.loanFilter = \"\";\n    this.investorSortKey = \"\";\n    this.investorSortDir = \"asc\";\n    this.loanSortKey = \"\";\n    this.loanSortDir = \"asc\";\n    this.investorPage = 0;\n    this.loanPage = 0;\n    this.pageSize = 5;\n    this.pageSizeOptions = [5, 10, 25];\n    this.aiQuestion = \"\";\n    this.aiAnswer = \"\";\n    this.aiLoading = false;\n    this.aiHistory = [];\n    this.selectedHorizon = \"6m\";\n    this.aiOpen = true;\n    this.modelFamilies = [{\n      id: \"ensemble\",\n      label: \"Ensemble (RF+GB)\"\n    }, {\n      id: \"rf\",\n      label: \"Random Forest\"\n    }, {\n      id: \"logreg\",\n      label: \"Logistic Regression\"\n    }];\n    this.selectedFamily = \"ensemble\";\n    this.thresholdValue = 0.5;\n  }\n  ngOnInit() {\n    this.loadData();\n  }\n  loadData() {\n    this.loading = true;\n    this.api.batchRefresh().subscribe({\n      next: () => {\n        forkJoin({\n          investors: this.api.getInvestors(),\n          loans: this.api.getLoans(),\n          report: this.api.generateReport(),\n          analytics: this.api.getAnalyticsOverview(),\n          samples: this.api.getAnalyticsSamples(50),\n          metrics: this.api.getAllModelMetrics(),\n          timeline: this.api.getTimeline(45).pipe(catchError(() => of({\n            dates: [],\n            churn: [],\n            default: []\n          })))\n        }).subscribe({\n          next: ({\n            investors,\n            loans,\n            report,\n            analytics,\n            samples,\n            timeline,\n            metrics\n          }) => {\n            this.investors = investors.items;\n            this.loans = loans.items;\n            this.report = report;\n            this.samples = samples;\n            this.timeline = timeline;\n            this.analyticsRaw = analytics;\n            this.modelMetrics = metrics;\n            // prefer full investor/loan lists to avoid empty sample payloads\n            this.investorRows = investors.items || [];\n            this.loanRows = loans.items || [];\n            this.populateCharts(analytics);\n            this.loading = false;\n            this.cdr.detectChanges();\n          },\n          error: err => this.handleError(\"Failed to load dashboard data\", err)\n        });\n      },\n      error: err => this.handleError(\"Failed to refresh scores\", err)\n    });\n  }\n  refreshReport() {\n    this.loading = true;\n    this.api.generateReport().subscribe({\n      next: report => {\n        this.report = report;\n        this.loading = false;\n        this.snackBar.open(\"Report refreshed\", \"Close\", {\n          duration: 2000\n        });\n      },\n      error: err => this.handleError(\"Failed to refresh report\", err)\n    });\n  }\n  changeHorizon(h) {\n    this.selectedHorizon = h;\n    if (this.analyticsRaw) {\n      this.populateCharts(this.analyticsRaw);\n    }\n  }\n  changeFamily(fam) {\n    this.selectedFamily = fam;\n  }\n  investorBuckets() {\n    return this.report?.summary_kpis.investor_buckets || {\n      Low: 0,\n      Medium: 0,\n      High: 0\n    };\n  }\n  loanBuckets() {\n    return this.report?.summary_kpis.loan_buckets || {\n      Low: 0,\n      Medium: 0,\n      High: 0\n    };\n  }\n  topInvestors() {\n    return this.report?.summary_kpis.top_investors || [];\n  }\n  topLoans() {\n    return this.report?.summary_kpis.top_loans || [];\n  }\n  formatPercent(prob) {\n    if (prob === undefined || prob === null) {\n      return \"0.0%\";\n    }\n    return `${(prob * 100).toFixed(1)}%`;\n  }\n  populateCharts(analytics) {\n    if (!analytics) {\n      this.charts.churnBuckets = {\n        labels: [\"Low\", \"Medium\", \"High\"],\n        data: [0, 0, 0]\n      };\n      this.charts.defaultBuckets = {\n        labels: [\"Low\", \"Medium\", \"High\"],\n        data: [0, 0, 0]\n      };\n      this.charts.sectorExposure = {\n        labels: [],\n        data: []\n      };\n      this.charts.aumBuckets = {\n        labels: [],\n        data: []\n      };\n      this.charts.yieldEngagementTrend = {\n        labels: [],\n        data: []\n      };\n      this.charts.dscrSummary = {\n        labels: [\"p25\", \"p50\", \"p75\"],\n        data: [0, 0, 0]\n      };\n      return;\n    }\n    const h = this.selectedHorizon;\n    const churnSrc = analytics.churn_buckets_by_horizon?.[h] || analytics.churn_buckets || {};\n    const defaultSrc = analytics.default_buckets_by_horizon?.[h] || analytics.default_buckets || {};\n    this.charts.churnBuckets = {\n      labels: Object.keys(churnSrc || {}),\n      data: Object.values(churnSrc || {})\n    };\n    this.charts.defaultBuckets = {\n      labels: Object.keys(defaultSrc || {}),\n      data: Object.values(defaultSrc || {})\n    };\n    const sortedSector = Object.entries(analytics.sector_exposure || {}).sort((a, b) => b[1].exposure - a[1].exposure);\n    this.charts.sectorExposure = {\n      labels: sortedSector.map(s => s[0]),\n      data: sortedSector.map(s => s[1].exposure)\n    };\n    this.charts.aumBuckets = {\n      labels: Object.keys(analytics.aum_buckets || {}),\n      data: Object.values(analytics.aum_buckets || {})\n    };\n    // Create a simple line series for yield and engagement medians to show trend-like context\n    const yieldMed = analytics.distribution_yield?.p50 ?? 0;\n    const engMed = analytics.engagement?.p50 ?? 0;\n    this.charts.yieldEngagementTrend = {\n      labels: [\"Engagement median\", \"Yield median\"],\n      data: [engMed, yieldMed * 100]\n    };\n    const dscr = analytics.dscr || {};\n    this.charts.dscrSummary = {\n      labels: [\"p25\", \"p50\", \"p75\"],\n      data: [dscr.p25 ?? 0, dscr.p50 ?? 0, dscr.p75 ?? 0]\n    };\n  }\n  applyInvestorFilter(filterValue) {\n    this.investorFilter = filterValue.trim().toLowerCase();\n    this.investorPage = 0;\n  }\n  applyLoanFilter(filterValue) {\n    this.loanFilter = filterValue.trim().toLowerCase();\n    this.loanPage = 0;\n  }\n  filteredInvestors() {\n    const term = this.investorFilter || \"\";\n    if (!term) return this.investorRows;\n    return this.investorRows.filter(i => [i.name, i.risk_tolerance, i.risk_bucket].some(v => (v || \"\").toString().toLowerCase().includes(term)));\n  }\n  filteredLoans() {\n    const term = this.loanFilter || \"\";\n    if (!term) return this.loanRows;\n    return this.loanRows.filter(l => [l.id, l.sector, l.risk_bucket].some(v => (v || \"\").toString().toLowerCase().includes(term)));\n  }\n  sortArray(arr, key, dir) {\n    if (!key) return arr;\n    return [...arr].sort((a, b) => {\n      const va = a?.[key] ?? \"\";\n      const vb = b?.[key] ?? \"\";\n      if (va < vb) return dir === \"asc\" ? -1 : 1;\n      if (va > vb) return dir === \"asc\" ? 1 : -1;\n      return 0;\n    });\n  }\n  sortedInvestors() {\n    return this.sortArray(this.filteredInvestors(), this.investorSortKey, this.investorSortDir);\n  }\n  sortedLoans() {\n    return this.sortArray(this.filteredLoans(), this.loanSortKey, this.loanSortDir);\n  }\n  pagedInvestors() {\n    const start = this.investorPage * this.pageSize;\n    return this.sortedInvestors().slice(start, start + this.pageSize);\n  }\n  pagedLoans() {\n    const start = this.loanPage * this.pageSize;\n    return this.sortedLoans().slice(start, start + this.pageSize);\n  }\n  setInvestorPage(delta) {\n    const total = this.filteredInvestors().length;\n    const maxPage = Math.max(0, Math.ceil(total / this.pageSize) - 1);\n    this.investorPage = Math.min(maxPage, Math.max(0, this.investorPage + delta));\n  }\n  setLoanPage(delta) {\n    const total = this.filteredLoans().length;\n    const maxPage = Math.max(0, Math.ceil(total / this.pageSize) - 1);\n    this.loanPage = Math.min(maxPage, Math.max(0, this.loanPage + delta));\n  }\n  changePageSize(size) {\n    this.pageSize = size;\n    this.investorPage = 0;\n    this.loanPage = 0;\n  }\n  toggleInvestorSort(key) {\n    if (this.investorSortKey === key) {\n      this.investorSortDir = this.investorSortDir === \"asc\" ? \"desc\" : \"asc\";\n    } else {\n      this.investorSortKey = key;\n      this.investorSortDir = \"asc\";\n    }\n    this.investorPage = 0;\n  }\n  toggleLoanSort(key) {\n    if (this.loanSortKey === key) {\n      this.loanSortDir = this.loanSortDir === \"asc\" ? \"desc\" : \"asc\";\n    } else {\n      this.loanSortKey = key;\n      this.loanSortDir = \"asc\";\n    }\n    this.loanPage = 0;\n  }\n  askAi() {\n    if (!this.aiQuestion) return;\n    this.aiLoading = true;\n    this.aiHistory.push({\n      role: \"user\",\n      content: this.aiQuestion\n    });\n    const context = {\n      report: this.report,\n      charts: this.charts,\n      timeline: this.timeline,\n      topInvestors: this.topInvestors(),\n      topLoans: this.topLoans(),\n      samples: this.samples\n    };\n    this.api.askAi(this.aiQuestion, \"dashboard\", context, this.aiHistory).subscribe({\n      next: resp => {\n        this.aiAnswer = resp.answer;\n        this.aiHistory.push({\n          role: \"assistant\",\n          content: resp.answer\n        });\n        this.aiLoading = false;\n        this.aiQuestion = \"\";\n      },\n      error: err => this.handleError(\"AI explanation failed\", err)\n    });\n  }\n  handleError(message, err) {\n    console.error(message, err);\n    this.loading = false;\n    this.snackBar.open(message, \"Close\", {\n      duration: 3000\n    });\n  }\n  familyMetrics() {\n    const famBlock = this.modelMetrics?.model_families || {};\n    const h = this.selectedHorizon;\n    return {\n      churn: famBlock.churn?.[this.selectedFamily]?.[h],\n      default: famBlock.default?.[this.selectedFamily]?.[h]\n    };\n  }\n  cohortRisk() {\n    return this.analyticsRaw?.cohort_risk || {};\n  }\n  nearestThreshold(problem) {\n    const thresholds = this.modelMetrics?.thresholds?.[problem]?.[this.selectedHorizon] || [];\n    if (!thresholds.length) return null;\n    let best = thresholds[0];\n    let bestDiff = Math.abs(best.threshold - this.thresholdValue);\n    for (const t of thresholds) {\n      const diff = Math.abs(t.threshold - this.thresholdValue);\n      if (diff < bestDiff) {\n        best = t;\n        bestDiff = diff;\n      }\n    }\n    return best;\n  }\n  thresholdStats() {\n    return {\n      churn: this.nearestThreshold(\"churn\"),\n      default: this.nearestThreshold(\"default\")\n    };\n  }\n};\nDashboardComponent = __decorate([Component({\n  selector: \"app-dashboard\",\n  templateUrl: \"./dashboard.component.html\",\n  styleUrls: [\"./dashboard.component.scss\"]\n})], DashboardComponent);\nexport { DashboardComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}