{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Component } from \"@angular/core\";\nimport { forkJoin, of } from \"rxjs\";\nimport { catchError } from \"rxjs/operators\";\nlet DashboardComponent = class DashboardComponent {\n  constructor(api, snackBar, cdr) {\n    this.api = api;\n    this.snackBar = snackBar;\n    this.cdr = cdr;\n    this.investors = [];\n    this.loans = [];\n    this.Math = Math;\n    this.loading = false;\n    this.charts = {\n      churnBuckets: {\n        labels: [],\n        data: []\n      },\n      defaultBuckets: {\n        labels: [],\n        data: []\n      },\n      sectorExposure: {\n        labels: [],\n        data: []\n      },\n      aumBuckets: {\n        labels: [],\n        data: []\n      },\n      yieldEngagementTrend: {\n        labels: [],\n        data: []\n      },\n      dscrSummary: {\n        labels: [],\n        data: []\n      }\n    };\n    this.timeline = {\n      dates: [],\n      churn: [],\n      default: []\n    };\n    this.chartOptions = {\n      responsive: true,\n      plugins: {\n        legend: {\n          display: false\n        }\n      },\n      scales: {\n        x: {\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.05)\"\n          }\n        },\n        y: {\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.05)\"\n          },\n          beginAtZero: true\n        }\n      }\n    };\n    this.samples = {\n      investors: [],\n      loans: []\n    };\n    this.investorRows = [];\n    this.loanRows = [];\n    this.investorCount = 0;\n    this.loanCount = 0;\n    this.investorFilter = \"\";\n    this.loanFilter = \"\";\n    this.investorSortKey = \"\";\n    this.investorSortDir = \"asc\";\n    this.loanSortKey = \"\";\n    this.loanSortDir = \"asc\";\n    this.investorPage = 0;\n    this.loanPage = 0;\n    this.pageSize = 5;\n    this.pageSizeOptions = [5, 10, 25];\n    this.aiQuestion = \"\";\n    this.aiAnswer = \"\";\n    this.aiLoading = false;\n    this.aiHistory = [];\n    this.selectedHorizon = \"6m\";\n    this.aiOpen = true;\n    this.modelFamilies = [{\n      id: \"ensemble\",\n      label: \"Ensemble (RF+GB)\"\n    }, {\n      id: \"rf\",\n      label: \"Random Forest\"\n    }, {\n      id: \"logreg\",\n      label: \"Logistic Regression\"\n    }, {\n      id: \"adaboost\",\n      label: \"AdaBoost\"\n    }, {\n      id: \"bagging\",\n      label: \"Bagging\"\n    }, {\n      id: \"knn\",\n      label: \"k-NN (local)\"\n    }];\n    this.selectedFamily = \"ensemble\";\n    this.compareFamily = \"adaboost\";\n    this.thresholdValue = 0.5;\n    this.costFP = 1000;\n    this.costFN = 5000;\n    this.alerts = {\n      investors: [],\n      loans: [],\n      summary: {}\n    };\n    this.slaThreshold = 5;\n    this.interventions = [];\n    this.selectedInvestor = null;\n    this.selectedLoan = null;\n    this.rocData = {\n      datasets: []\n    };\n    this.prData = {\n      datasets: []\n    };\n    this.radarData = {\n      labels: [],\n      datasets: []\n    };\n    this.bucketData = {\n      labels: [\"Low\", \"Medium\", \"High\"],\n      datasets: []\n    };\n    this.compareRoc = {\n      datasets: []\n    };\n    this.comparePr = {\n      datasets: []\n    };\n    this.predictorCharts = {\n      churn: {\n        labels: [],\n        datasets: []\n      },\n      default: {\n        labels: [],\n        datasets: []\n      }\n    };\n    this.singleFeatureCharts = {};\n    this.coeffStability = {};\n    this.modelComparator = {\n      labels: [],\n      datasets: []\n    };\n    this.diagnosticsCurves = {};\n    this.selectionCurves = {\n      datasets: []\n    };\n    this.selectionCurvesDefault = {\n      datasets: []\n    };\n    this.selectionCurvesGb = {\n      datasets: []\n    };\n    this.selectionCurvesGbDefault = {\n      datasets: []\n    };\n    this.nonLinearCharts = {};\n    this.rocExplorer = {\n      datasets: []\n    };\n    this.edaCharts = {};\n    this.fairnessCharts = {};\n    this.segmentRocCharts = {};\n    this.biasGapCharts = {};\n    this.votingCharts = {};\n    this.surfaceSlices = {};\n    this.dashboardContrib = {};\n    this.selectedInvestorId = null;\n    this.selectedLoanId = null;\n    this.lineOptions = {\n      responsive: true,\n      plugins: {\n        legend: {\n          display: true,\n          labels: {\n            color: \"#9bb0c9\"\n          }\n        }\n      },\n      elements: {\n        point: {\n          radius: 2\n        }\n      },\n      parsing: false,\n      scales: {\n        x: {\n          type: \"linear\",\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.08)\"\n          }\n        },\n        y: {\n          min: 0,\n          max: 1,\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.08)\"\n          }\n        }\n      }\n    };\n    this.segmentHeatmaps = {};\n    this.brokerHeatmaps = {};\n    this.surfaceOptions = {\n      responsive: true,\n      plugins: {\n        legend: {\n          display: true,\n          labels: {\n            color: \"#9bb0c9\"\n          }\n        }\n      },\n      elements: {\n        point: {\n          radius: 0\n        }\n      },\n      parsing: false,\n      scales: {\n        x: {\n          type: \"linear\",\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.08)\"\n          }\n        },\n        y: {\n          ticks: {\n            color: \"#9bb0c9\"\n          },\n          grid: {\n            color: \"rgba(255,255,255,0.08)\"\n          }\n        }\n      }\n    };\n  }\n  ngOnInit() {\n    this.loadData();\n  }\n  loadData() {\n    this.loading = true;\n    this.api.batchRefresh().subscribe({\n      next: () => {\n        forkJoin({\n          investors: this.api.getInvestors(),\n          loans: this.api.getLoans(),\n          report: this.api.generateReport(),\n          analytics: this.api.getAnalyticsOverview(),\n          samples: this.api.getAnalyticsSamples(50),\n          metrics: this.api.getAllModelMetrics(),\n          drift: this.api.getDrift().pipe(catchError(() => of(null))),\n          audit: this.api.getDataAudit().pipe(catchError(() => of(null))),\n          alerts: this.api.getAlerts().pipe(catchError(() => of(null))),\n          timeline: this.api.getTimeline(45).pipe(catchError(() => of({\n            dates: [],\n            churn: [],\n            default: []\n          }))),\n          interventions: this.api.getInterventions().pipe(catchError(() => of([]))),\n          eda: this.api.getEdaSummary().pipe(catchError(() => of(null)))\n        }).subscribe({\n          next: ({\n            investors,\n            loans,\n            report,\n            analytics,\n            samples,\n            timeline,\n            metrics,\n            drift,\n            audit,\n            alerts,\n            interventions,\n            eda\n          }) => {\n            this.investors = investors.items;\n            this.loans = loans.items;\n            this.report = report;\n            this.samples = samples;\n            this.timeline = timeline;\n            this.analyticsRaw = analytics;\n            this.modelMetrics = metrics;\n            this.segmentHeatmaps = metrics?.segment_heatmaps || {};\n            this.brokerHeatmaps = {\n              churn: metrics?.segment_heatmaps?.churn_broker_by_tolerance,\n              default: metrics?.segment_heatmaps?.default_broker_by_sector\n            };\n            this.driftSummary = drift;\n            this.dataAudit = audit;\n            this.alerts = alerts;\n            this.aiKpiSnapshot = this.buildKpiSnapshot();\n            this.predictorCharts = this.buildPredictorCharts();\n            this.singleFeatureCharts = this.buildSingleFeatureCharts();\n            this.diagnosticsCurves = this.buildDiagnosticsCharts();\n            this.selectionCurves = this.buildSelectionCurves(\"churn\", \"rf_estimators\");\n            this.selectionCurvesDefault = this.buildSelectionCurves(\"default\", \"rf_estimators\");\n            this.selectionCurvesGb = this.buildSelectionCurves(\"churn\", \"gb_learning_rate\");\n            this.selectionCurvesGbDefault = this.buildSelectionCurves(\"default\", \"gb_learning_rate\");\n            this.nonLinearCharts = this.buildNonLinearCharts();\n            this.imbalance = metrics?.imbalance;\n            this.imbalanceDetail = metrics?.imbalance;\n            this.robustness = metrics?.robustness;\n            this.coeffStability = metrics?.bootstrap_coefficients || {};\n            this.interventions = interventions;\n            this.edaSummary = eda;\n            this.regressionKpi = metrics?.regression_kpi;\n            this.rocExplorer = this.buildRocExplorer();\n            this.edaCharts = this.buildEdaCharts();\n            this.fairnessCharts = this.buildFairnessCharts();\n            this.forecaster = metrics?.forecaster;\n            this.missingHeatmap = audit?.heatmap;\n            this.segmentBias = metrics?.segment_bias;\n            this.segmentRocCharts = this.buildSegmentRocCharts();\n            this.biasGapCharts = this.buildBiasCharts();\n            this.votingCharts = this.buildVotingCharts();\n            this.surfaceSlices = this.buildSurfaceSlices();\n            this.selectedInvestorId = investors.items?.[0]?.id ?? null;\n            this.selectedLoanId = loans.items?.[0]?.id ?? null;\n            this.dashboardContrib = this.buildDashboardContrib();\n            this.updateCurveData();\n            // prefer full investor/loan lists to avoid empty sample payloads\n            this.investorRows = investors.items || [];\n            this.loanRows = loans.items || [];\n            this.investorCount = investors.items?.length || 0;\n            this.loanCount = loans.items?.length || 0;\n            this.populateCharts(analytics);\n            this.loading = false;\n            this.cdr.detectChanges();\n          },\n          error: err => this.handleError(\"Failed to load dashboard data\", err)\n        });\n      },\n      error: err => this.handleError(\"Failed to refresh scores\", err)\n    });\n  }\n  refreshReport() {\n    this.loading = true;\n    this.api.generateReport().subscribe({\n      next: report => {\n        this.report = report;\n        this.loading = false;\n        this.snackBar.open(\"Report refreshed\", \"Close\", {\n          duration: 2000\n        });\n      },\n      error: err => this.handleError(\"Failed to refresh report\", err)\n    });\n  }\n  changeHorizon(h) {\n    this.selectedHorizon = h;\n    if (this.analyticsRaw) {\n      this.populateCharts(this.analyticsRaw);\n    }\n    this.updateCurveData();\n  }\n  changeFamily(fam) {\n    this.selectedFamily = fam;\n    this.updateCurveData();\n    this.updateRadar();\n    this.updateComparisonCurves();\n  }\n  setSelectedInvestor(id) {\n    this.selectedInvestorId = id;\n    this.dashboardContrib = this.buildDashboardContrib();\n  }\n  setSelectedLoan(id) {\n    this.selectedLoanId = id;\n    this.dashboardContrib = this.buildDashboardContrib();\n  }\n  explainDashboard() {\n    this.aiQuestion = \"Explain todayâ€™s dashboard risk picture in 3 bullets.\";\n    this.askAi();\n  }\n  heatmap(name) {\n    return this.segmentHeatmaps?.[name];\n  }\n  investorBuckets() {\n    return this.report?.summary_kpis.investor_buckets || {\n      Low: 0,\n      Medium: 0,\n      High: 0\n    };\n  }\n  loanBuckets() {\n    return this.report?.summary_kpis.loan_buckets || {\n      Low: 0,\n      Medium: 0,\n      High: 0\n    };\n  }\n  topInvestors() {\n    return this.report?.summary_kpis.top_investors || [];\n  }\n  topLoans() {\n    return this.report?.summary_kpis.top_loans || [];\n  }\n  formatPercent(prob) {\n    if (prob === undefined || prob === null) {\n      return \"0.0%\";\n    }\n    return `${(prob * 100).toFixed(1)}%`;\n  }\n  populateCharts(analytics) {\n    if (!analytics) {\n      this.charts.churnBuckets = {\n        labels: [\"Low\", \"Medium\", \"High\"],\n        data: [0, 0, 0]\n      };\n      this.charts.defaultBuckets = {\n        labels: [\"Low\", \"Medium\", \"High\"],\n        data: [0, 0, 0]\n      };\n      this.charts.sectorExposure = {\n        labels: [],\n        data: []\n      };\n      this.charts.aumBuckets = {\n        labels: [],\n        data: []\n      };\n      this.charts.yieldEngagementTrend = {\n        labels: [],\n        data: []\n      };\n      this.charts.dscrSummary = {\n        labels: [\"p25\", \"p50\", \"p75\"],\n        data: [0, 0, 0]\n      };\n      return;\n    }\n    const h = this.selectedHorizon;\n    const churnSrc = analytics.churn_buckets_by_horizon?.[h] || analytics.churn_buckets || {};\n    const defaultSrc = analytics.default_buckets_by_horizon?.[h] || analytics.default_buckets || {};\n    this.charts.churnBuckets = {\n      labels: Object.keys(churnSrc || {}),\n      data: Object.values(churnSrc || {})\n    };\n    this.charts.defaultBuckets = {\n      labels: Object.keys(defaultSrc || {}),\n      data: Object.values(defaultSrc || {})\n    };\n    const sortedSector = Object.entries(analytics.sector_exposure || {}).sort((a, b) => b[1].exposure - a[1].exposure);\n    this.charts.sectorExposure = {\n      labels: sortedSector.map(s => s[0]),\n      data: sortedSector.map(s => s[1].exposure)\n    };\n    this.charts.aumBuckets = {\n      labels: Object.keys(analytics.aum_buckets || {}),\n      data: Object.values(analytics.aum_buckets || {})\n    };\n    // Create a simple line series for yield and engagement medians to show trend-like context\n    const yieldMed = analytics.distribution_yield?.p50 ?? 0;\n    const engMed = analytics.engagement?.p50 ?? 0;\n    this.charts.yieldEngagementTrend = {\n      labels: [\"Engagement median\", \"Yield median\"],\n      data: [engMed, yieldMed * 100]\n    };\n    const dscr = analytics.dscr || {};\n    this.charts.dscrSummary = {\n      labels: [\"p25\", \"p50\", \"p75\"],\n      data: [dscr.p25 ?? 0, dscr.p50 ?? 0, dscr.p75 ?? 0]\n    };\n  }\n  applyInvestorFilter(filterValue) {\n    this.investorFilter = filterValue.trim().toLowerCase();\n    this.investorPage = 0;\n  }\n  applyLoanFilter(filterValue) {\n    this.loanFilter = filterValue.trim().toLowerCase();\n    this.loanPage = 0;\n  }\n  filteredInvestors() {\n    const term = this.investorFilter || \"\";\n    if (!term) return this.investorRows;\n    return this.investorRows.filter(i => [i.name, i.risk_tolerance, i.risk_bucket].some(v => (v || \"\").toString().toLowerCase().includes(term)));\n  }\n  filteredLoans() {\n    const term = this.loanFilter || \"\";\n    if (!term) return this.loanRows;\n    return this.loanRows.filter(l => [l.id, l.sector, l.risk_bucket].some(v => (v || \"\").toString().toLowerCase().includes(term)));\n  }\n  sortArray(arr, key, dir) {\n    if (!key) return arr;\n    return [...arr].sort((a, b) => {\n      const va = a?.[key] ?? \"\";\n      const vb = b?.[key] ?? \"\";\n      if (va < vb) return dir === \"asc\" ? -1 : 1;\n      if (va > vb) return dir === \"asc\" ? 1 : -1;\n      return 0;\n    });\n  }\n  sortedInvestors() {\n    return this.sortArray(this.filteredInvestors(), this.investorSortKey, this.investorSortDir);\n  }\n  sortedLoans() {\n    return this.sortArray(this.filteredLoans(), this.loanSortKey, this.loanSortDir);\n  }\n  pagedInvestors() {\n    const start = this.investorPage * this.pageSize;\n    return this.sortedInvestors().slice(start, start + this.pageSize);\n  }\n  pagedLoans() {\n    const start = this.loanPage * this.pageSize;\n    return this.sortedLoans().slice(start, start + this.pageSize);\n  }\n  setInvestorPage(delta) {\n    const total = this.filteredInvestors().length;\n    const maxPage = Math.max(0, Math.ceil(total / this.pageSize) - 1);\n    this.investorPage = Math.min(maxPage, Math.max(0, this.investorPage + delta));\n  }\n  setLoanPage(delta) {\n    const total = this.filteredLoans().length;\n    const maxPage = Math.max(0, Math.ceil(total / this.pageSize) - 1);\n    this.loanPage = Math.min(maxPage, Math.max(0, this.loanPage + delta));\n  }\n  changePageSize(size) {\n    this.pageSize = size;\n    this.investorPage = 0;\n    this.loanPage = 0;\n  }\n  toggleInvestorSort(key) {\n    if (this.investorSortKey === key) {\n      this.investorSortDir = this.investorSortDir === \"asc\" ? \"desc\" : \"asc\";\n    } else {\n      this.investorSortKey = key;\n      this.investorSortDir = \"asc\";\n    }\n    this.investorPage = 0;\n  }\n  toggleLoanSort(key) {\n    if (this.loanSortKey === key) {\n      this.loanSortDir = this.loanSortDir === \"asc\" ? \"desc\" : \"asc\";\n    } else {\n      this.loanSortKey = key;\n      this.loanSortDir = \"asc\";\n    }\n    this.loanPage = 0;\n  }\n  askAi() {\n    if (!this.aiQuestion) return;\n    this.aiLoading = true;\n    this.aiHistory.push({\n      role: \"user\",\n      content: this.aiQuestion\n    });\n    const context = {\n      report: this.report,\n      charts: this.charts,\n      timeline: this.timeline,\n      topInvestors: this.topInvestors(),\n      topLoans: this.topLoans(),\n      samples: this.samples,\n      kpis: this.aiKpiSnapshot,\n      metrics: this.modelMetrics\n    };\n    this.api.askAi(this.aiQuestion, \"dashboard\", context, this.aiHistory).subscribe({\n      next: resp => {\n        this.aiAnswer = resp.answer;\n        this.aiHistory.push({\n          role: \"assistant\",\n          content: resp.answer\n        });\n        this.aiLoading = false;\n        this.aiQuestion = \"\";\n      },\n      error: err => this.handleError(\"AI explanation failed\", err)\n    });\n  }\n  buildKpiSnapshot() {\n    const analytics = this.analyticsRaw || {};\n    return {\n      churn_buckets: analytics.churn_buckets_by_horizon?.[this.selectedHorizon] || analytics.churn_buckets,\n      default_buckets: analytics.default_buckets_by_horizon?.[this.selectedHorizon] || analytics.default_buckets,\n      sector_exposure: analytics.sector_exposure,\n      cohort_risk: analytics.cohort_risk,\n      deltas: this.report?.summary_kpis?.deltas,\n      model_family_metrics: this.familyMetrics()\n    };\n  }\n  handleError(message, err) {\n    console.error(message, err);\n    this.loading = false;\n    this.snackBar.open(message, \"Close\", {\n      duration: 3000\n    });\n  }\n  familyMetrics() {\n    const famBlock = this.modelMetrics?.model_families || {};\n    const h = this.selectedHorizon;\n    return {\n      churn: famBlock.churn?.[this.selectedFamily]?.[h],\n      default: famBlock.default?.[this.selectedFamily]?.[h]\n    };\n  }\n  thresholdsFor(problem) {\n    const famBlock = this.modelMetrics?.model_families?.[problem]?.[this.selectedFamily]?.[this.selectedHorizon];\n    const familyThresholds = famBlock?.thresholds || [];\n    if (familyThresholds.length) return familyThresholds;\n    return this.modelMetrics?.thresholds?.[problem]?.[this.selectedHorizon] || [];\n  }\n  cohortRisk() {\n    return this.analyticsRaw?.cohort_risk || {};\n  }\n  nearestThreshold(problem) {\n    const thresholds = this.thresholdsFor(problem);\n    if (!thresholds.length) return null;\n    let best = thresholds[0];\n    let bestDiff = Math.abs(best.threshold - this.thresholdValue);\n    for (const t of thresholds) {\n      const diff = Math.abs(t.threshold - this.thresholdValue);\n      if (diff < bestDiff) {\n        best = t;\n        bestDiff = diff;\n      }\n    }\n    return best;\n  }\n  thresholdStats() {\n    return {\n      churn: this.nearestThreshold(\"churn\"),\n      default: this.nearestThreshold(\"default\")\n    };\n  }\n  segmentScores() {\n    return this.analyticsRaw?.segment_scores || {};\n  }\n  predictorBenchmarks() {\n    const bench = this.modelMetrics?.single_feature_benchmarks || {};\n    const toRows = obj => Object.entries(obj || {}).map(([name, val]) => ({\n      name,\n      auc: val?.roc_auc || 0\n    })).sort((a, b) => b.auc - a.auc);\n    return {\n      churn: toRows(bench.churn),\n      default: toRows(bench.default)\n    };\n  }\n  buildPredictorCharts() {\n    const bench = this.predictorBenchmarks();\n    const churnLabels = bench.churn.map(r => r.name);\n    const churnData = bench.churn.map(r => r.auc);\n    const defLabels = bench.default.map(r => r.name);\n    const defData = bench.default.map(r => r.auc);\n    const familyAuc = this.modelMetrics?.model_families?.churn ? Object.entries(this.modelMetrics.model_families.churn).map(([fam, hv]) => ({\n      family: fam,\n      auc: hv?.[\"6m\"]?.roc_auc || 0\n    })) : [];\n    const familyAucDefault = this.modelMetrics?.model_families?.default ? Object.entries(this.modelMetrics.model_families.default).map(([fam, hv]) => ({\n      family: fam,\n      auc: hv?.[\"6m\"]?.roc_auc || 0\n    })) : [];\n    return {\n      churn: {\n        labels: churnLabels,\n        datasets: [{\n          label: \"Churn single-feature AUC\",\n          data: churnData,\n          backgroundColor: \"#0ea5e9\"\n        }]\n      },\n      default: {\n        labels: defLabels,\n        datasets: [{\n          label: \"Default single-feature AUC\",\n          data: defData,\n          backgroundColor: \"#f59e0b\"\n        }]\n      },\n      families: {\n        labels: familyAuc.map(r => r.family),\n        datasets: [{\n          label: \"Churn AUC by family (6m)\",\n          data: familyAuc.map(r => r.auc),\n          backgroundColor: \"#10b981\"\n        }]\n      },\n      familiesDefault: {\n        labels: familyAucDefault.map(r => r.family),\n        datasets: [{\n          label: \"Default AUC by family (6m)\",\n          data: familyAucDefault.map(r => r.auc),\n          backgroundColor: \"#6366f1\"\n        }]\n      }\n    };\n  }\n  buildDiagnosticsCharts() {\n    const diag = this.modelMetrics?.diagnostics_1d || {};\n    const makeLine = (d, colorA, colorB, labelA, labelB) => {\n      if (!d?.x) return undefined;\n      return {\n        labels: d.x,\n        datasets: [{\n          data: d.logistic || [],\n          label: labelA,\n          borderColor: colorA,\n          backgroundColor: \"rgba(0,0,0,0)\",\n          tension: 0.2,\n          fill: false\n        }, {\n          data: d.knn || [],\n          label: labelB,\n          borderColor: colorB,\n          backgroundColor: \"rgba(0,0,0,0)\",\n          tension: 0.2,\n          fill: false\n        }]\n      };\n    };\n    return {\n      churn: makeLine(diag.churn, \"#22c55e\", \"#ef4444\", \"Logistic\", \"k-NN\"),\n      default: makeLine(diag.default, \"#3b82f6\", \"#f97316\", \"Logistic\", \"k-NN\")\n    };\n  }\n  buildSingleFeatureCharts() {\n    const sf = this.modelMetrics?.single_feature_benchmarks || {};\n    const make = (obj, color, label) => {\n      if (!obj) return undefined;\n      const entries = Object.entries(obj);\n      return {\n        labels: entries.map(e => e[0]),\n        datasets: [{\n          label,\n          data: entries.map(e => e[1]?.roc_auc || 0),\n          backgroundColor: color\n        }]\n      };\n    };\n    return {\n      churn: make(sf.churn, \"#22c55e\", \"Single feature AUC\"),\n      default: make(sf.default, \"#ef4444\", \"Single feature AUC\")\n    };\n  }\n  buildSegmentRocCharts() {\n    const bias = this.modelMetrics?.segment_bias || {};\n    const make = (rows, color, label) => {\n      if (!rows?.length) return undefined;\n      return {\n        labels: rows.map(r => r.segment),\n        datasets: [{\n          label,\n          data: rows.map(r => r.auc || 0),\n          backgroundColor: color\n        }]\n      };\n    };\n    return {\n      churn: make(bias.churn?.by_segment, \"#10b981\", \"AUC by tolerance\"),\n      default: make(bias.default?.by_segment, \"#6366f1\", \"AUC by sector\")\n    };\n  }\n  buildBiasCharts() {\n    const bias = this.modelMetrics?.segment_bias || {};\n    const make = (rows, label, key, color) => {\n      if (!rows?.length) return undefined;\n      return {\n        labels: rows.map(r => r.segment),\n        datasets: [{\n          label,\n          data: rows.map(r => (r?.[key] || 0) * 100),\n          backgroundColor: color\n        }]\n      };\n    };\n    return {\n      churn: make(bias.churn?.by_segment, \"TPR gap vs overall (%)\", \"tpr_gap\", \"#f59e0b\"),\n      default: make(bias.default?.by_segment, \"TPR gap vs overall (%)\", \"tpr_gap\", \"#f97316\")\n    };\n  }\n  buildVotingCharts() {\n    const voting = this.modelMetrics?.voting_importance || {};\n    const make = (rows, color) => {\n      if (!rows?.length) return undefined;\n      const top = rows.slice(0, 8);\n      return {\n        labels: top.map(r => r.feature),\n        datasets: [{\n          label: \"Voting score\",\n          data: top.map(r => r.score || 0),\n          backgroundColor: color\n        }]\n      };\n    };\n    return {\n      churn: make(voting.churn, \"#0ea5e9\"),\n      default: make(voting.default, \"#a855f7\")\n    };\n  }\n  buildSurfaceSlices() {\n    const surf = this.modelMetrics?.surfaces || {};\n    const build = (obj, color) => {\n      if (!obj?.x || !obj?.y || !obj?.z) return undefined;\n      const datasets = obj.y.slice(0, 3).map((yVal, idx) => ({\n        label: `${obj.y_label || \"y\"}=${yVal.toFixed(1)}`,\n        data: obj.z[idx].map((val, xi) => ({\n          x: obj.x[xi],\n          y: val\n        })),\n        borderColor: color,\n        backgroundColor: \"rgba(0,0,0,0)\",\n        tension: 0.15,\n        fill: false\n      }));\n      return {\n        datasets\n      };\n    };\n    return {\n      churn: build(surf.churn, \"#22c55e\"),\n      default: build(surf.default, \"#ef4444\")\n    };\n  }\n  buildDashboardContrib() {\n    const contrib = this.modelMetrics?.contributions || {};\n    const investor = this.selectedInvestorId ? contrib.churn?.[this.selectedInvestorId] : null;\n    const loan = this.selectedLoanId ? contrib.default?.[this.selectedLoanId] : null;\n    const make = (obj, color, label) => obj ? {\n      labels: Object.keys(obj),\n      datasets: [{\n        label,\n        data: Object.values(obj),\n        backgroundColor: color\n      }]\n    } : undefined;\n    return {\n      investor: make(investor, \"#0ea5e9\", \"Contribution\"),\n      loan: make(loan, \"#f97316\", \"Contribution\")\n    };\n  }\n  buildSelectionCurves(problem, key) {\n    const sel = this.modelMetrics?.model_selection?.[problem]?.[key];\n    if (!sel) return {\n      datasets: []\n    };\n    const params = sel.params || [];\n    return {\n      labels: params,\n      datasets: [{\n        label: \"Train AUC\",\n        data: sel.train || [],\n        borderColor: \"#22c55e\",\n        tension: 0.15,\n        fill: false\n      }, {\n        label: \"Val AUC\",\n        data: sel.val || [],\n        borderColor: \"#f59e0b\",\n        tension: 0.15,\n        fill: false\n      }, {\n        label: \"CV AUC\",\n        data: sel.cv || [],\n        borderColor: \"#6366f1\",\n        tension: 0.15,\n        fill: false\n      }]\n    };\n  }\n  selectionSeedTable() {\n    const sel = this.modelMetrics?.model_selection?.churn?.rf_estimators;\n    const seeds = this.modelMetrics?.model_selection?.churn?.seeds || [1, 7, 21];\n    if (!sel?.seed_runs) return {\n      seeds: [],\n      rows: []\n    };\n    const rows = sel.seed_runs.map((run, idx) => ({\n      param: sel.params?.[idx],\n      scores: run || [],\n      mean: run && run.length ? run.reduce((a, b) => a + b, 0) / run.length : 0\n    }));\n    return {\n      seeds,\n      rows\n    };\n  }\n  missingnessGrid(kind) {\n    const hm = this.missingHeatmap?.[kind];\n    if (!hm?.rows || !hm?.cols) return null;\n    return hm;\n  }\n  buildRocExplorer() {\n    const thresholds = this.thresholdsFor(\"churn\");\n    const points = thresholds.map(t => ({\n      x: t.fpr,\n      y: t.tpr\n    }));\n    const scenarioPts = [0.33, 0.5, 0.66].map(thr => {\n      const nearest = thresholds.reduce((prev, curr) => Math.abs(curr.threshold - thr) < Math.abs((prev?.threshold ?? 0) - thr) ? curr : prev, thresholds[0] || {});\n      return {\n        x: nearest?.fpr || 0,\n        y: nearest?.tpr || 0\n      };\n    });\n    return {\n      datasets: [{\n        label: \"Churn ROC\",\n        data: points,\n        borderColor: \"#0ea5e9\",\n        backgroundColor: \"rgba(14,165,233,0.2)\",\n        showLine: true,\n        tension: 0.1,\n        fill: false\n      }, {\n        label: \"Scenario thresholds\",\n        data: scenarioPts,\n        borderColor: \"#f59e0b\",\n        backgroundColor: \"rgba(245,158,11,0.4)\",\n        showLine: false,\n        pointRadius: 5,\n        fill: false\n      }]\n    };\n  }\n  buildNonLinearCharts() {\n    const nl = this.modelMetrics?.non_linear || {};\n    const make = (series, label, color) => {\n      if (!series) return undefined;\n      return {\n        labels: series.x,\n        datasets: [{\n          data: series.y,\n          label,\n          borderColor: color,\n          tension: 0.15,\n          fill: false\n        }]\n      };\n    };\n    return {\n      churn: make(nl.churn?.engagement_score, \"Churn vs engagement\", \"#22c55e\"),\n      default: make(nl.default?.ltv_ratio, \"Default vs LTV\", \"#ef4444\")\n    };\n  }\n  buildEdaCharts() {\n    const eda = this.modelMetrics?.eda;\n    if (!eda) return {};\n    const invHist = eda.investor?.hist || {};\n    const loanHist = eda.loan?.hist || {};\n    const makeHist = hist => ({\n      labels: (hist.bins || []).slice(0, -1).map((b, idx) => `${b.toFixed(1)}-${hist.bins[idx + 1]?.toFixed(1)}`),\n      datasets: [{\n        data: hist.counts || [],\n        backgroundColor: \"#60a5fa\"\n      }]\n    });\n    const invCorr = eda.investor?.corr || {};\n    const loanCorr = eda.loan?.corr || {};\n    return {\n      investor: {\n        engagement: invHist.engagement_score ? makeHist(invHist.engagement_score) : null,\n        email_open: invHist.email_open_rate ? makeHist(invHist.email_open_rate) : null,\n        age: invHist.age ? makeHist(invHist.age) : null,\n        corr: invCorr,\n        outliers: eda.investor?.outliers\n      },\n      loan: {\n        ltv: loanHist.ltv_ratio ? makeHist(loanHist.ltv_ratio) : null,\n        dscr: loanHist.dscr ? makeHist(loanHist.dscr) : null,\n        corr: loanCorr,\n        outliers: eda.loan?.outliers\n      }\n    };\n  }\n  buildFairnessCharts() {\n    const seg = this.modelMetrics?.segment_roc || {};\n    const toBar = (obj, color, label) => obj ? {\n      labels: Object.keys(obj || {}),\n      datasets: [{\n        label,\n        data: Object.values(obj || {}),\n        backgroundColor: color\n      }]\n    } : undefined;\n    const churn = toBar(seg.churn, \"#22c55e\", \"Churn AUC\");\n    const churnAp = toBar(seg.churn_ap, \"#0ea5e9\", \"Churn AP\");\n    const def = toBar(seg.default, \"#f59e0b\", \"Default AUC\");\n    const defAp = toBar(seg.default_ap, \"#8b5cf6\", \"Default AP\");\n    return {\n      churn,\n      churnAp,\n      default: def,\n      defAp\n    };\n  }\n  hyperparams() {\n    return this.modelMetrics?.hyperparameters || {};\n  }\n  sensitivityRows() {\n    const sens = this.modelMetrics?.sensitivity || {};\n    const toRows = obj => Object.entries(obj || {}).map(([feat, vals]) => ({\n      feature: feat,\n      up: (vals?.up_flip_pct || 0) * 100,\n      down: (vals?.down_flip_pct || 0) * 100\n    })).sort((a, b) => b.up - a.up);\n    return {\n      churn: toRows(sens.churn),\n      default: toRows(sens.default)\n    };\n  }\n  thresholdCost(problem) {\n    const stats = this.thresholdStats()[problem];\n    if (!stats) return null;\n    const fp = stats.fp || 0;\n    const fn = stats.fn || 0;\n    return {\n      fp,\n      fn,\n      cost_fp: fp * this.costFP,\n      cost_fn: fn * this.costFN,\n      total: fp * this.costFP + fn * this.costFN\n    };\n  }\n  runPortfolioScenario() {\n    this.loading = true;\n    this.api.runPortfolioScenario({\n      horizon: this.selectedHorizon\n    }).subscribe({\n      next: resp => {\n        this.scenarioResult = resp;\n        this.loading = false;\n        this.snackBar.open(\"Scenario calculated\", \"Close\", {\n          duration: 2000\n        });\n      },\n      error: err => this.handleError(\"Failed to run portfolio scenario\", err)\n    });\n  }\n  imputationRows() {\n    const missing = this.modelMetrics?.missing_data || {};\n    const toRows = obj => Object.entries(obj || {}).map(([name, vals]) => ({\n      strategy: name,\n      auc: vals?.roc_auc || 0,\n      ap: vals?.avg_precision || 0,\n      retained: (vals?.retained_pct || 0) * 100\n    }));\n    const churnRows = toRows(missing.churn);\n    const defaultRows = toRows(missing.default);\n    const bestChurn = [...churnRows].sort((a, b) => b.auc - a.auc)[0];\n    const bestDefault = [...defaultRows].sort((a, b) => b.auc - a.auc)[0];\n    return {\n      churn: churnRows,\n      default: defaultRows,\n      bestChurn,\n      bestDefault\n    };\n  }\n  bootstrapStats() {\n    return this.modelMetrics?.bootstrap_ci || {};\n  }\n  cohortModels() {\n    return this.modelMetrics?.cohort_models || {};\n  }\n  selectInvestor(inv) {\n    this.selectedInvestor = inv;\n    this.selectedLoan = null;\n  }\n  selectLoan(loan) {\n    this.selectedLoan = loan;\n    this.selectedInvestor = null;\n  }\n  updateCurveData() {\n    const churnThr = this.thresholdsFor(\"churn\");\n    const defaultThr = this.thresholdsFor(\"default\");\n    this.rocData = {\n      datasets: [{\n        label: \"Churn ROC\",\n        data: churnThr.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#19c3b1\",\n        backgroundColor: \"rgba(25,195,177,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }, {\n        label: \"Default ROC\",\n        data: defaultThr.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#4f46e5\",\n        backgroundColor: \"rgba(79,70,229,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }]\n    };\n    this.prData = {\n      datasets: [{\n        label: \"Churn PR\",\n        data: churnThr.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#10b981\",\n        backgroundColor: \"rgba(16,185,129,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }, {\n        label: \"Default PR\",\n        data: defaultThr.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#f59e0b\",\n        backgroundColor: \"rgba(245,158,11,0.2)\",\n        tension: 0.15,\n        showLine: true,\n        fill: false\n      }]\n    };\n    this.updateRadar();\n    this.updateComparisonCurves();\n  }\n  updateRadar() {\n    const fam = this.familyMetrics();\n    const churn = fam?.churn || {};\n    const defm = fam?.default || {};\n    const labels = [\"Accuracy\", \"Precision\", \"Recall\", \"ROC AUC\", \"Avg Precision\"];\n    const churnVals = [churn.accuracy || 0, churn.precision || 0, churn.recall || 0, churn.roc_auc || 0, churn.avg_precision || 0];\n    const defVals = [defm.accuracy || 0, defm.precision || 0, defm.recall || 0, defm.roc_auc || 0, defm.avg_precision || 0];\n    this.radarData = {\n      labels,\n      datasets: [{\n        label: \"Churn\",\n        data: churnVals,\n        borderColor: \"#19c3b1\",\n        backgroundColor: \"rgba(25,195,177,0.2)\"\n      }, {\n        label: \"Default\",\n        data: defVals,\n        borderColor: \"#4f46e5\",\n        backgroundColor: \"rgba(79,70,229,0.2)\"\n      }]\n    };\n    const churnBuckets = [churn.bucket_low || 0, churn.bucket_med || 0, churn.bucket_high || 0];\n    const defaultBuckets = [defm.bucket_low || 0, defm.bucket_med || 0, defm.bucket_high || 0];\n    this.bucketData = {\n      labels: [\"Low\", \"Medium\", \"High\"],\n      datasets: [{\n        label: \"Churn buckets\",\n        data: churnBuckets,\n        backgroundColor: \"rgba(25,195,177,0.4)\"\n      }, {\n        label: \"Default buckets\",\n        data: defaultBuckets,\n        backgroundColor: \"rgba(79,70,229,0.4)\"\n      }]\n    };\n  }\n  changeCompareFamily(f) {\n    this.compareFamily = f;\n    this.updateComparisonCurves();\n  }\n  thresholdsForFamily(problem, family) {\n    const famBlock = this.modelMetrics?.model_families?.[problem]?.[family]?.[this.selectedHorizon];\n    return famBlock?.thresholds || [];\n  }\n  updateComparisonCurves() {\n    const famA = this.selectedFamily;\n    const famB = this.compareFamily;\n    const churnA = this.thresholdsForFamily(\"churn\", famA);\n    const churnB = this.thresholdsForFamily(\"churn\", famB);\n    const defA = this.thresholdsForFamily(\"default\", famA);\n    const defB = this.thresholdsForFamily(\"default\", famB);\n    this.compareRoc = {\n      datasets: [{\n        label: `Churn ${famA}`,\n        data: churnA.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#19c3b1\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Churn ${famB}`,\n        data: churnB.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#f97316\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famA}`,\n        data: defA.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#4f46e5\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famB}`,\n        data: defB.map(t => ({\n          x: t.fpr,\n          y: t.tpr\n        })),\n        borderColor: \"#22c55e\",\n        fill: false,\n        tension: 0.1\n      }]\n    };\n    this.comparePr = {\n      datasets: [{\n        label: `Churn ${famA}`,\n        data: churnA.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#10b981\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Churn ${famB}`,\n        data: churnB.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#f59e0b\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famA}`,\n        data: defA.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#6366f1\",\n        fill: false,\n        tension: 0.1\n      }, {\n        label: `Default ${famB}`,\n        data: defB.map(t => ({\n          x: t.recall,\n          y: t.precision\n        })),\n        borderColor: \"#ef4444\",\n        fill: false,\n        tension: 0.1\n      }]\n    };\n  }\n};\nDashboardComponent = __decorate([Component({\n  selector: \"app-dashboard\",\n  templateUrl: \"./dashboard.component.html\",\n  styleUrls: [\"./dashboard.component.scss\"]\n})], DashboardComponent);\nexport { DashboardComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}